import{r as l,j as e,d as p}from"./index-BhbzFmRm.js";import{F as g,I as y,R as se,B as o,C as ae,S as M,j as L,d as w,T as v}from"./index-kBbHJYa7.js";import{R as ne}from"./DownloadOutlined-DWBHGFBM.js";import{I as K,s as d}from"./index-CEnH4XFE.js";import{L as _}from"./index-DGiGROfW.js";import{T as R}from"./index-ealqDkwN.js";import{P as U,F as re,M as z}from"./Table-B3Aa-BfP.js";import{R as le}from"./UserOutlined-B1RR1i8_.js";import"./index-DcAOwtUU.js";var ie={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M928 160H96c-17.7 0-32 14.3-32 32v640c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V192c0-17.7-14.3-32-32-32zm-40 110.8V792H136V270.8l-27.6-21.5 39.3-50.5 42.8 33.3h643.1l42.8-33.3 39.3 50.5-27.7 21.5zM833.6 232L512 482 190.4 232l-42.8-33.3-39.3 50.5 27.6 21.5 341.6 265.6a55.99 55.99 0 0068.7 0L888 270.8l27.6-21.5-39.3-50.5-42.7 33.2z"}}]},name:"mail",theme:"outlined"};function O(){return O=Object.assign?Object.assign.bind():function(i){for(var n=1;n<arguments.length;n++){var c=arguments[n];for(var m in c)Object.prototype.hasOwnProperty.call(c,m)&&(i[m]=c[m])}return i},O.apply(this,arguments)}const ce=(i,n)=>l.createElement(K,O({},i,{ref:n,icon:ie})),N=l.forwardRef(ce);var oe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M909.1 209.3l-56.4 44.1C775.8 155.1 656.2 92 521.9 92 290 92 102.3 279.5 102 511.5 101.7 743.7 289.8 932 521.9 932c181.3 0 335.8-115 394.6-276.1 1.5-4.2-.7-8.9-4.9-10.3l-56.7-19.5a8 8 0 00-10.1 4.8c-1.8 5-3.8 10-5.9 14.9-17.3 41-42.1 77.8-73.7 109.4A344.77 344.77 0 01655.9 829c-42.3 17.9-87.4 27-133.8 27-46.5 0-91.5-9.1-133.8-27A341.5 341.5 0 01279 755.2a342.16 342.16 0 01-73.7-109.4c-17.9-42.4-27-87.4-27-133.9s9.1-91.5 27-133.9c17.3-41 42.1-77.8 73.7-109.4 31.6-31.6 68.4-56.4 109.3-73.8 42.3-17.9 87.4-27 133.8-27 46.5 0 91.5 9.1 133.8 27a341.5 341.5 0 01109.3 73.8c9.9 9.9 19.2 20.4 27.8 31.4l-60.2 47a8 8 0 003 14.1l175.6 43c5 1.2 9.9-2.6 9.9-7.7l.8-180.9c-.1-6.6-7.8-10.3-13-6.2z"}}]},name:"reload",theme:"outlined"};function A(){return A=Object.assign?Object.assign.bind():function(i){for(var n=1;n<arguments.length;n++){var c=arguments[n];for(var m in c)Object.prototype.hasOwnProperty.call(c,m)&&(i[m]=c[m])}return i},A.apply(this,arguments)}const de=(i,n)=>l.createElement(K,A({},i,{ref:n,icon:oe})),xe=l.forwardRef(de),we=()=>{const[i,n]=l.useState([]),[c,m]=l.useState([]),[T,D]=l.useState(!0),[x,f]=l.useState([]),[F,q]=l.useState(""),[H,C]=l.useState(!1),[W,S]=l.useState(!1),[r,P]=l.useState(null),[$]=g.useForm(),[b,G]=l.useState(window.innerWidth<768);l.useEffect(()=>{const t=()=>G(window.innerWidth<768);return window.addEventListener("resize",t),()=>window.removeEventListener("resize",t)},[]);const E=async()=>{try{D(!0);const t=await p.get("/messages");n(t.data),m(t.data)}catch(t){console.error("Failed to fetch messages:",t),d.error("加载留言失败")}finally{D(!1)}};l.useEffect(()=>{E()},[]),l.useEffect(()=>{const t=F.toLowerCase(),s=i.filter(a=>a.name.toLowerCase().includes(t)||a.email.toLowerCase().includes(t)||a.content.toLowerCase().includes(t)||a.subject.toLowerCase().includes(t));m(s)},[F,i]);const V=async t=>{try{await p.patch(`/messages/${t}/read`),d.success("已标记为已读"),Y(t,{isRead:!0})}catch{d.error("操作失败")}},J=async()=>{if(x.length!==0)try{await p.post("/messages/batch/read",{ids:x}),d.success(`已将 ${x.length} 条留言标记为已读`),n(t=>t.map(s=>x.includes(s.id)?{...s,isRead:!0}:s)),f([])}catch{d.error("批量操作失败")}},I=async t=>{try{await p.delete(`/messages/${t}`),d.success("删除成功"),n(s=>s.filter(a=>a.id!==t)),(r==null?void 0:r.id)===t&&C(!1)}catch{d.error("删除失败")}},Q=async()=>{if(x.length!==0)try{await p.post("/messages/batch/delete",{ids:x}),d.success(`已删除 ${x.length} 条留言`),n(t=>t.filter(s=>!x.includes(s.id))),f([])}catch{d.error("批量删除失败")}},X=()=>{if(c.length===0){d.warning("没有数据可导出");return}try{const s=[["ID","姓名","邮箱","主题","内容","状态","创建时间"].join(","),...c.map(h=>[h.id,`"${h.name.replace(/"/g,'""')}"`,`"${h.email.replace(/"/g,'""')}"`,`"${h.subject.replace(/"/g,'""')}"`,`"${h.content.replace(/"/g,'""')}"`,h.isRead?"已读":"未读",h.createdAt].join(","))].join(`
`),a=new Blob([s],{type:"text/csv;charset=utf-8;"}),u=URL.createObjectURL(a),j=document.createElement("a");j.href=u,j.setAttribute("download",`messages_export_${new Date().toISOString().slice(0,10)}.csv`),document.body.appendChild(j),j.click(),document.body.removeChild(j)}catch(t){d.error("导出失败"),console.error(t)}},Y=(t,s)=>{n(a=>a.map(u=>u.id===t?{...u,...s}:u))},B=t=>{P(t),C(!0),t.isRead||V(t.id)},k=t=>{P(t),$.setFieldsValue({to:t.email,subject:`Re: ${t.subject}`,content:`

------------------
Original Message:
From: ${t.name}
Date: ${new Date(t.createdAt).toLocaleString()}

${t.content}`}),S(!0)},Z=async()=>{try{const t=await $.validateFields();await new Promise(s=>setTimeout(s,1e3)),d.success("回复已发送 (模拟)"),S(!1),window.location.href=`mailto:${t.to}?subject=${encodeURIComponent(t.subject)}&body=${encodeURIComponent(t.content)}`}catch{}},ee={selectedRowKeys:x,onChange:t=>f(t)},te=[{title:"状态",dataIndex:"isRead",key:"isRead",width:100,render:t=>t?e.jsx(R,{color:"success",icon:e.jsx(L,{}),children:"已读"}):e.jsx(R,{color:"error",icon:e.jsx(N,{}),children:"未读"}),filters:[{text:"已读",value:!0},{text:"未读",value:!1}],onFilter:(t,s)=>s.isRead===t},{title:"姓名",dataIndex:"name",key:"name",width:150,render:t=>e.jsx("span",{className:"font-medium text-gray-700",children:t})},{title:"邮箱",dataIndex:"email",key:"email",width:200,render:t=>e.jsx(v,{title:t,children:e.jsx("div",{className:"truncate max-w-[180px] text-gray-500 hover:text-blue-600 cursor-pointer",children:t})})},{title:"内容",key:"content",render:(t,s)=>e.jsxs("div",{className:"max-w-md",children:[e.jsx("div",{className:"font-medium text-gray-800 mb-1 truncate",children:s.subject}),e.jsx("div",{className:"text-gray-500 text-sm truncate",children:s.content})]})},{title:"时间",dataIndex:"createdAt",key:"createdAt",width:180,sorter:(t,s)=>new Date(t.createdAt).getTime()-new Date(s.createdAt).getTime(),render:t=>e.jsx("span",{className:"text-gray-500 text-sm",children:new Date(t).toLocaleString()})},{title:"操作",key:"action",width:150,fixed:"right",render:(t,s)=>e.jsxs(M,{size:"small",children:[e.jsx(v,{title:"快速回复",children:e.jsx(o,{type:"text",icon:e.jsx(N,{}),className:"text-blue-600 hover:bg-blue-50",onClick:a=>{a.stopPropagation(),k(s)}})}),e.jsx(v,{title:s.isRead?"已读":"标记为已读",children:e.jsx(o,{type:"text",disabled:s.isRead,icon:e.jsx(L,{}),className:s.isRead?"text-gray-300":"text-green-600 hover:bg-green-50",onClick:a=>{a.stopPropagation(),V(s.id)}})}),e.jsx(v,{title:"删除",children:e.jsx(U,{title:"确定删除这条留言吗?",onConfirm:a=>{a==null||a.stopPropagation(),I(s.id)},onCancel:a=>a==null?void 0:a.stopPropagation(),children:e.jsx(o,{type:"text",danger:!0,icon:e.jsx(w,{}),onClick:a=>a.stopPropagation()})})})]})}];return e.jsxs("div",{className:"p-4 md:p-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl md:text-2xl font-bold text-gray-900",children:"留言管理"}),e.jsx("p",{className:"text-gray-500 mt-1 text-sm",children:"查看和回复来自网站的访客留言"})]}),e.jsxs("div",{className:"flex gap-2 w-full md:w-auto",children:[e.jsx(y,{placeholder:"搜索姓名、邮箱或内容...",prefix:e.jsx(se,{className:"text-gray-400"}),onChange:t=>q(t.target.value),className:"flex-1 md:w-[250px]",allowClear:!0}),e.jsx(o,{icon:e.jsx(ne,{}),onClick:X}),e.jsx(o,{icon:e.jsx(xe,{}),onClick:E})]})]}),e.jsxs(ae,{bordered:!1,className:"shadow-sm rounded-xl overflow-hidden",bodyStyle:{padding:0},children:[x.length>0&&e.jsxs("div",{className:"bg-blue-50 px-4 py-3 flex items-center justify-between border-b border-blue-100",children:[e.jsxs("span",{className:"text-blue-700 text-sm",children:["已选 ",e.jsx("span",{className:"font-bold",children:x.length})]}),e.jsxs(M,{size:"small",children:[!b&&e.jsx(o,{size:"small",onClick:()=>f([]),children:"取消"}),e.jsx(o,{size:"small",onClick:J,icon:e.jsx(L,{}),children:!b&&"标记已读"}),e.jsx(o,{size:"small",danger:!0,onClick:Q,icon:e.jsx(w,{}),children:!b&&"删除"})]})]}),b?e.jsx(_,{dataSource:c,rowKey:"id",loading:T,pagination:{onChange:t=>{console.log(t)},pageSize:10},renderItem:t=>e.jsx(_.Item,{onClick:()=>B(t),className:"cursor-pointer hover:bg-gray-50 px-4 py-3 border-b border-gray-100 last:border-0",children:e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsx("div",{className:"font-bold text-gray-900 truncate pr-2",children:t.name}),e.jsx("div",{className:"text-xs text-gray-400 whitespace-nowrap",children:new Date(t.createdAt).toLocaleDateString()})]}),e.jsx("div",{className:"text-sm font-medium text-gray-800 mb-1 truncate",children:t.subject}),e.jsx("div",{className:"text-xs text-gray-500 line-clamp-2 mb-2",children:t.content}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(R,{color:t.isRead?"success":"error",className:"mr-0",children:t.isRead?"已读":"未读"}),e.jsxs(M,{onClick:s=>s.stopPropagation(),children:[e.jsx(o,{type:"text",size:"small",icon:e.jsx(N,{}),className:"text-blue-600",onClick:()=>k(t)}),e.jsx(U,{title:"删除?",onConfirm:()=>I(t.id),placement:"topRight",children:e.jsx(o,{type:"text",size:"small",danger:!0,icon:e.jsx(w,{})})})]})]})]})},t.id)}):e.jsx(re,{rowSelection:ee,columns:te,dataSource:c,rowKey:"id",loading:T,pagination:{defaultPageSize:10,showTotal:t=>`共 ${t} 条留言`,showSizeChanger:!0},onRow:t=>({onClick:()=>B(t),className:"cursor-pointer hover:bg-blue-50 transition-colors"})})]}),e.jsx(z,{title:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(le,{})," 留言详情"]}),open:H,onCancel:()=>C(!1),footer:[e.jsx(o,{danger:!0,icon:e.jsx(w,{}),onClick:()=>{r&&z.confirm({title:"确定删除?",content:"删除后无法恢复",okType:"danger",onOk:()=>I(r.id)})},children:"删除"},"delete"),e.jsx(o,{type:"primary",icon:e.jsx(N,{}),onClick:()=>r&&k(r),children:"回复"},"reply")],width:600,children:r&&e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold text-lg",children:r.name.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("div",{className:"font-bold text-gray-900",children:r.name}),e.jsx("div",{className:"text-gray-500 text-sm",children:r.email})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx(R,{color:r.isRead?"success":"error",children:r.isRead?"已读":"未读"}),e.jsx("div",{className:"text-xs text-gray-400 mt-1",children:new Date(r.createdAt).toLocaleString()})]})]}),e.jsxs("div",{className:"bg-gray-50 rounded-xl p-4 border border-gray-100",children:[e.jsx("div",{className:"font-bold text-gray-800 mb-2 border-b border-gray-200 pb-2",children:r.subject}),e.jsx("div",{className:"whitespace-pre-wrap text-gray-700 leading-relaxed",children:r.content})]})]})}),e.jsx(z,{title:"快速回复",open:W,onOk:Z,onCancel:()=>S(!1),okText:"发送邮件",cancelText:"取消",children:e.jsxs(g,{form:$,layout:"vertical",children:[e.jsx(g.Item,{name:"to",label:"收件人",children:e.jsx(y,{disabled:!0})}),e.jsx(g.Item,{name:"subject",label:"主题",rules:[{required:!0,message:"请输入主题"}],children:e.jsx(y,{})}),e.jsx(g.Item,{name:"content",label:"内容",rules:[{required:!0,message:"请输入回复内容"}],children:e.jsx(y.TextArea,{rows:6})})]})})]})};export{we as default};
